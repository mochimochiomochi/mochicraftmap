<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>mochimap</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style type="text/css">
html {
    margin: 0;
    width: 100%;
    height: 100%;
}
body {
    margin: 0;
    width: 100%;
    height: 100%;
}
canvas {
    margin: 0;
    background-color: black;
}
</style>
</head>
<body>
    <canvas id="mainmap" width="1200" height="800"></canvas>
</body>
<script type="text/javascript">
(function(){
    var zoom = 5;
    var tileSize = 512;
    var canvas = document.getElementById("mainmap");
    var canvasWidth = canvas.width = document.body.clientWidth - 2;
    var canvasHeight = canvas.height = document.body.clientHeight - 2;
    var context = canvas.getContext("2d");
    var prevX = prevY = 0;
    
    var eventStart = ("ontouchstart" in window) ? "touchstart" : "mousedown";
    var eventEnd = ("ontouchend" in window) ? "touchend" : "mouseup";
    var eventMove = ("ontouchmove" in window) ? "touchmove" : "mousemove";
    
    var loadImage = function(filename){
        var img = new Image();
        img.src = filename;
        return img;
    };
    var drawImage = function(filename, context, x, y, w, h){
        var img = new Image();
        img.src = filename;
        img.onload = function(){
            context.clearRect(x, y, w, h);
            context.drawImage(img, x, y, w, h);
        };
        img.onerror = function(){
            context.clearRect(x, y, w, h);
        };
    };
    
    var offsetX = offsetY = 0;
    var scrollFlag = false;
    
    var draw = function(){
        //context.clearRect(0, 0, canvasWidth, canvasHeight);

        var ix = Math.floor(-offsetX / tileSize);
        var iy = Math.floor(-offsetY / tileSize);
        var bx = offsetX % tileSize;
        if (bx > 0) {
            bx -= tileSize;
        }
        var by = offsetY % tileSize;
        if (by > 0) {
            by -= tileSize;
        }

        var xnum = Math.ceil(canvasWidth / tileSize);
        var ynum = Math.ceil(canvasHeight / tileSize);
        for (var j = 0; j <= ynum; ++j) {
            for (var i = 0; i <= xnum; ++i) {
                var fname = "tile." + (ix + i) + "." + (iy + j) + ".png";
                //context.drawImage(loadImage(fname), bx + tileSize * i, by + tileSize * j, tileSize, tileSize);
                drawImage(fname, context, bx + tileSize * i, by + tileSize * j, tileSize, tileSize);
                //context.fillText(fname, bx + 512 * i, by + 512 * j);
            }
        }
    };
    
    setInterval(function(){
        context.clearRect(0, 0, 100, 20);
        context.fillStyle = "white";
        context.fillText(offsetX + "," + offsetY, 10, 10);
    }, 300);
    
    var mouseevent = function(event){
        event.preventDefault();
        if (scrollFlag) {
            var cx = event.touches ? event.touches[0].clientX : event.clientX;
            var cy = event.touches ? event.touches[0].clientY : event.clientY;
            offsetX += cx - prevX;
            offsetY += cy - prevY;
            prevX = cx;
            prevY = cy;
            draw();
        }
    };
    canvas.addEventListener(eventMove, mouseevent);
    canvas.addEventListener(eventEnd, function(){
        event.preventDefault();
        scrollFlag = false;
    });
    canvas.addEventListener(eventStart, function(event){
        event.preventDefault();
        scrollFlag = true;
        prevX = event.touches ? event.touches[0].clientX : event.clientX;
        prevY = event.touches ? event.touches[0].clientY : event.clientY;
    });
    canvas.addEventListener("wheel", function(event){
        event.preventDefault();
        console.log(event);
        if (event.wheelDelta > 0) {
            if (++zoom > 7) {
                zoom = 7;
            } else {
                offsetX *= 2;
                offsetY *= 2;
            }
        } else {
            if (--zoom < 3) {
                zoom = 3;
            } else {
                offsetX /= 2;
                offsetY /= 2;
            }
        }
        //console.log(offsetX, offsetY);
        tileSize = Math.pow(2, zoom) * 16;
        context.clearRect(0, 0, canvasWidth, canvasHeight);
        draw();
    });
    
    window.addEventListener("resize", function(event){
        console.log(event);
        canvasWidth = canvas.width = document.body.clientWidth - 2;
        canvasHeight = canvas.height = document.body.clientHeight - 2;
        context.clearRect(0, 0, canvasWidth, canvasHeight);
        draw();
    });

    draw();
})();
</script>
</html>
