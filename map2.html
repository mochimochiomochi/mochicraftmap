<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>mochimap</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style type="text/css">
html {
    margin: 0;
    width: 100%;
    height: 100%;
}
body {
    margin: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
}
canvas {
    margin: 0;
    background-color: black;
}
span.sign {
    position: absolute;
    white-space: pre;
    text-shadow: 2px 2px 2px #444444;
    background-color: rgba(255, 255, 255, 0.7);
}
</style>
</head>
<body>
    <canvas id="mainmap" width="1200" height="800"></canvas>
</body>
<script type="text/javascript">
MAP_SIGNS = [];
(function(){
    var zoom = 5;
    var tileSize = 512;
    var canvas = document.getElementById("mainmap");
    var canvasWidth = canvas.width = document.body.clientWidth - 2;
    var canvasHeight = canvas.height = document.body.clientHeight - 2;
    var context = canvas.getContext("2d");
    var prevX = prevY = 0;
    var pinchDistance = pinchStartDistance = 0;
    
    var eventStart = ("ontouchstart" in window) ? "touchstart" : "mousedown";
    var eventEnd = ("ontouchend" in window) ? "touchend" : "mouseup";
    var eventMove = ("ontouchmove" in window) ? "touchmove" : "mousemove";
    
    var signs;
    fetch("signs.json").then(function(res){
        return res.json();
    }).then(function(json){
        signs = json;
        signs.forEach(function(obj, n){
            var ele = document.createElement("span");
            ele.className = "sign";
            ele.setAttribute("id", "sign-" + n);
            ele.textContent = obj.name;
            document.body.appendChild(ele);
        });
    });

    var loadImage = function(filename){
        var img = new Image();
        img.src = filename;
        return img;
    };
    var drawImage = function(filename, context, x, y, w, h){
        var img = new Image();
        img.src = filename;
        img.onload = function(){
            context.clearRect(x, y, w, h);
            context.drawImage(img, x, y, w, h);
        };
        img.onerror = function(){
            context.clearRect(x, y, w, h);
        };
    };
    
    var offsetX = offsetY = 0;
    var scrollFlag = false;
    
    var draw = function(){
        //context.clearRect(0, 0, canvasWidth, canvasHeight);

        var ix = Math.floor(-offsetX / tileSize);
        var iy = Math.floor(-offsetY / tileSize);
        var bx = offsetX % tileSize;
        if (bx > 0) {
            bx -= tileSize;
        }
        var by = offsetY % tileSize;
        if (by > 0) {
            by -= tileSize;
        }

        var xnum = Math.ceil(canvasWidth / tileSize);
        var ynum = Math.ceil(canvasHeight / tileSize);
        for (var j = 0; j <= ynum; ++j) {
            for (var i = 0; i <= xnum; ++i) {
                var fname = "tile." + (ix + i) + "." + (iy + j) + ".png";
                //context.drawImage(loadImage(fname), bx + tileSize * i, by + tileSize * j, tileSize, tileSize);
                drawImage(fname, context, bx + tileSize * i, by + tileSize * j, tileSize, tileSize);
            }
        }
        if (signs) {
            var by = Math.pow(2, zoom - 5);
            signs.forEach(function(obj, n){
                var ele = document.getElementById("sign-" + n);
                ele.style.left = (offsetX + obj.x * by) + "px";
                ele.style.top = (offsetY + obj.y * by) + "px";
            });
        }
    };
    
    canvas.addEventListener(eventMove, function(){
        event.preventDefault();
        if (scrollFlag) {
            var cx = event.touches ? event.touches[0].clientX : event.clientX;
            var cy = event.touches ? event.touches[0].clientY : event.clientY;
            offsetX += cx - prevX;
            offsetY += cy - prevY;
            prevX = cx;
            prevY = cy;
            draw();
        }
        if (pinchStartDistance > 0 && event.touches && event.touches.length > 1) {
            pinchDistance = Math.sqrt(
                Math.pow(event.touches[1].clientX - event.touches[0].clientX, 2) + 
                Math.pow(event.touches[1].clientY - event.touches[0].clientY, 2)
            );
        }
    });
    canvas.addEventListener(eventEnd, function(){
        event.preventDefault();
        scrollFlag = false;

        if (pinchStartDistance > 0) {
            zooming(pinchDistance > pinchStartDistance);
            pinchStartDistance = 0;
        }
    });
    canvas.addEventListener(eventStart, function(event){
        event.preventDefault();
        scrollFlag = true;
        prevX = event.touches ? event.touches[0].clientX : event.clientX;
        prevY = event.touches ? event.touches[0].clientY : event.clientY;

        pinchStartDistance = 0;
        if (event.touches && event.touches.length > 1) {
            pinchStartDistance = Math.sqrt(
                Math.pow(event.touches[1].clientX - event.touches[0].clientX, 2) + 
                Math.pow(event.touches[1].clientY - event.touches[0].clientY, 2)
            );
        }
    });
    canvas.addEventListener("wheel", function(event){
        event.preventDefault();
        zooming(event.wheelDelta > 0);
    });
    canvas.addEventListener("dblclick", function(event){
        var by = Math.pow(2, zoom - 5);
        var x = (event.clientX - offsetX) / by;
        var y = (event.clientY - offsetY) / by;
        window.alert(x + "," + y);
    });
    
    var zooming = function(zoomin){
        if (zoomin) {
            if (++zoom > 7) {
                zoom = 7;
            } else {
                offsetX *= 2;
                offsetY *= 2;
            }
        } else {
            if (--zoom < 3) {
                zoom = 3;
            } else {
                offsetX /= 2;
                offsetY /= 2;
            }
        }
        tileSize = Math.pow(2, zoom) * 16;
        context.clearRect(0, 0, canvasWidth, canvasHeight);
        draw();
    };
    
    window.addEventListener("resize", function(event){
        canvasWidth = canvas.width = document.body.clientWidth - 2;
        canvasHeight = canvas.height = document.body.clientHeight - 2;
        context.clearRect(0, 0, canvasWidth, canvasHeight);
        draw();
    });

    draw();
})();
</script>
</html>
